test:
  pre:
    # start android emulator
    - case $CIRCLE_NODE_INDEX in 1) emulator -avd circleci-android22 -no-window -no-audio -no-boot-anim ;; esac:
        parallel: true
        background: true

  override:
    # run plugin tests
    - ./gradlew mvp-plugin:check

    # run sample unit tests
    # run sample connected tests
    - case $CIRCLE_NODE_INDEX in 0) ./gradlew mvp-plugin-sample:check ;; 1) ./gradlew connectedCheck ;; esac:
        parallel: true

  post:
    # copy test results to report directory
    - mkdir $CIRCLE_TEST_REPORTS/plugin-tests && cp -r mvp-plugin/build/test-results/*.xml $CIRCLE_TEST_REPORTS/plugin-tests
    - mkdir $CIRCLE_TEST_REPORTS/sample-unit-tests && cp -r mvp-plugin-sample/build/test-results/debug/*.xml $CIRCLE_TEST_REPORTS/sample-unit-tests
    - case $CIRCLE_NODE_INDEX in 1) mkdir $CIRCLE_TEST_REPORTS/sample-connected-tests && cp -r mvp-plugin-sample/build/outputs/androidTest-results/connected/* $CIRCLE_TEST_REPORTS/sample-connected-tests ;; esac:
        parallel: true

deployment:
  report-master:
    branch: master
    commands:
      # report code coverage to codacy for master branch
      - ./gradlew sendCoverageToCodacy